<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fa fa-tags"></i> Genres</h2>
                <a href="/genres/create" class="btn btn-primary">
                    <i class="fa fa-plus"></i> Add New Genre
                </a>
            </div>

            {{#if messages.success}}
                <div class="d-flex alert alert-success alert-dismissible fade show">
                    <span class="flex-grow-1">{{messages.success}}</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {{/if}}
            {{#if messages.error}}
                <div class="d-flex alert alert-danger alert-dismissible fade show">
                    <span class="flex-grow-1">{{messages.error}}</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {{/if}}

            <div class="card">
                <div class="card-body">
                    {{#if genres.length}}
                        <!-- Search and Filter Controls -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <input type="text" id="searchGenres" class="form-control" placeholder="Search genres...">
                            </div>
                            <div class="col-md-3">
                                <select id="sortGenres" class="form-select">
                                    <option value="">Sort by...</option>
                                    <option value="id-asc">ID (Ascending)</option>
                                    <option value="id-desc">ID (Descending)</option>
                                    <option value="name-asc">Name (A-Z)</option>
                                    <option value="name-desc">Name (Z-A)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select id="entriesPerPage" class="form-select">
                                    <option value="10">10 per page</option>
                                    <option value="25">25 per page</option>
                                    <option value="50">50 per page</option>
                                    <option value="100">100 per page</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="genresTable">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Genre Name</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each genres}}
                                    <tr data-id="{{this.GenreID}}" data-name="{{this.GenreName}}">
                                        <td>{{this.GenreID}}</td>
                                        <td>{{this.GenreName}}</td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary modify-btn" onclick="toggleActions(this)">
                                                <i class="fa fa-pencil"></i> Modify
                                            </button>
                                            <span class="action-buttons" style="display: none;">
                                                <a href="/genres/edit/{{this.GenreID}}" class="btn btn-sm btn-warning">
                                                    <i class="fa fa-edit"></i> Edit
                                                </a>
                                                <form action="/genres/delete/{{this.GenreID}}" method="POST" style="display: inline;" 
                                                      onsubmit="return confirm('Delete this genre? This will remove the genre from all associated books.');">
                                                    <input type="hidden" name="_csrf" value="{{../csrfToken}}">
                                                    <button type="submit" class="btn btn-sm btn-danger">
                                                        <i class="fa fa-trash"></i> Delete
                                                    </button>
                                                </form>
                                            </span>
                                        </td>
                                    </tr>
                                    {{/each}}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div id="tableInfo" class="text-muted"></div>
                            <nav>
                                <ul class="pagination mb-0" id="pagination"></ul>
                            </nav>
                        </div>

                        <script>
                            function toggleActions(btn) {
                                const row = btn.closest('tr');
                                const actionButtons = row.querySelector('.action-buttons');
                                const modifyBtn = row.querySelector('.modify-btn');
                                
                                // Hide all other action buttons
                                document.querySelectorAll('.action-buttons').forEach(ab => {
                                    if (ab !== actionButtons) ab.style.display = 'none';
                                });
                                document.querySelectorAll('.modify-btn').forEach(mb => {
                                    if (mb !== modifyBtn) mb.style.display = 'inline-block';
                                });
                                
                                // Toggle current row
                                if (actionButtons.style.display === 'none') {
                                    actionButtons.style.display = 'inline';
                                    modifyBtn.style.display = 'none';
                                } else {
                                    actionButtons.style.display = 'none';
                                    modifyBtn.style.display = 'inline-block';
                                }
                            }

                            let currentPage = 1;
                            let entriesPerPage = 10;
                            let filteredRows = [];

                            function initTable() {
                                const table = document.getElementById('genresTable');
                                const rows = Array.from(table.querySelectorAll('tbody tr'));
                                filteredRows = rows;
                                renderTable();
                            }

                            function renderTable() {
                                const table = document.getElementById('genresTable');
                                const tbody = table.querySelector('tbody');
                                const rows = Array.from(tbody.querySelectorAll('tr'));
                                
                                // Hide all rows first
                                rows.forEach(row => row.style.display = 'none');
                                
                                // Calculate pagination
                                const totalEntries = filteredRows.length;
                                const totalPages = Math.ceil(totalEntries / entriesPerPage);
                                const start = (currentPage - 1) * entriesPerPage;
                                const end = start + entriesPerPage;
                                
                                // Show only current page rows
                                filteredRows.slice(start, end).forEach(row => row.style.display = '');
                                
                                // Update info
                                const showing = filteredRows.length === 0 ? 0 : start + 1;
                                const to = Math.min(end, totalEntries);
                                document.getElementById('tableInfo').textContent = 
                                    `Showing ${showing} to ${to} of ${totalEntries} entries`;
                                
                                // Update pagination
                                renderPagination(totalPages);
                            }

                            function renderPagination(totalPages) {
                                const pagination = document.getElementById('pagination');
                                pagination.innerHTML = '';
                                
                                if (totalPages <= 1) return;
                                
                                // Previous button
                                const prevLi = document.createElement('li');
                                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                                prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>`;
                                pagination.appendChild(prevLi);
                                
                                // Page numbers
                                for (let i = 1; i <= totalPages; i++) {
                                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                                        const li = document.createElement('li');
                                        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                                        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
                                        pagination.appendChild(li);
                                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                                        const li = document.createElement('li');
                                        li.className = 'page-item disabled';
                                        li.innerHTML = '<a class="page-link" href="#">...</a>';
                                        pagination.appendChild(li);
                                    }
                                }
                                
                                // Next button
                                const nextLi = document.createElement('li');
                                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                                nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>`;
                                pagination.appendChild(nextLi);
                            }

                            function changePage(page) {
                                const totalPages = Math.ceil(filteredRows.length / entriesPerPage);
                                if (page < 1 || page > totalPages) return;
                                currentPage = page;
                                renderTable();
                            }

                            // Search functionality
                            document.getElementById('searchGenres').addEventListener('input', function(e) {
                                const searchTerm = e.target.value.toLowerCase();
                                const table = document.getElementById('genresTable');
                                const rows = Array.from(table.querySelectorAll('tbody tr'));
                                
                                filteredRows = rows.filter(row => {
                                    const id = row.dataset.id.toLowerCase();
                                    const name = row.dataset.name.toLowerCase();
                                    return id.includes(searchTerm) || name.includes(searchTerm);
                                });
                                
                                currentPage = 1;
                                renderTable();
                            });

                            // Sort functionality
                            document.getElementById('sortGenres').addEventListener('change', function(e) {
                                const sortValue = e.target.value;
                                
                                if (!sortValue) {
                                    initTable();
                                    return;
                                }
                                
                                const [field, order] = sortValue.split('-');
                                
                                filteredRows.sort((a, b) => {
                                    let aVal, bVal;
                                    
                                    if (field === 'id') {
                                        aVal = parseInt(a.dataset.id);
                                        bVal = parseInt(b.dataset.id);
                                    } else if (field === 'name') {
                                        aVal = a.dataset.name.toLowerCase();
                                        bVal = b.dataset.name.toLowerCase();
                                    }
                                    
                                    if (order === 'asc') {
                                        return aVal > bVal ? 1 : -1;
                                    } else {
                                        return aVal < bVal ? 1 : -1;
                                    }
                                });
                                
                                renderTable();
                            });

                            // Entries per page
                            document.getElementById('entriesPerPage').addEventListener('change', function(e) {
                                entriesPerPage = parseInt(e.target.value);
                                currentPage = 1;
                                renderTable();
                            });

                            // Initialize on page load
                            initTable();
                        </script>
                    {{else}}
                        <div class="alert alert-info text-center">
                            No genres found. <a href="/genres/create">Add your first genre</a>
                        </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</div>
