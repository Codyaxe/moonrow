<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fa fa-exchange"></i> Loans</h2>
                <a href="/loans/create" class="btn btn-primary">
                    <i class="fa fa-plus"></i> New Loan
                </a>
            </div>

            {{#if messages.success}}
                <div class="d-flex alert alert-success alert-dismissible fade show">
                    <span class="flex-grow-1">{{messages.success}}</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {{/if}}
            {{#if messages.error}}
                <div class="d-flex alert alert-danger alert-dismissible fade show">
                    <span class="flex-grow-1">{{messages.error}}</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {{/if}}

            <div class="card">
                <div class="card-body">
                    {{#if loans.length}}
                        <!-- Search and Filter Controls -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <input type="text" id="searchLoans" class="form-control" placeholder="Search loans...">
                            </div>
                            <div class="col-md-2">
                                <select id="filterStatus" class="form-select">
                                    <option value="">All Status</option>
                                    <option value="Borrowed">Borrowed</option>
                                    <option value="Returned">Returned</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select id="sortLoans" class="form-select">
                                    <option value="">Sort by...</option>
                                    <option value="id-asc">ID (Ascending)</option>
                                    <option value="id-desc">ID (Descending)</option>
                                    <option value="borrowdate-asc">Borrow Date (Oldest)</option>
                                    <option value="borrowdate-desc">Borrow Date (Newest)</option>
                                    <option value="returndate-asc">Return Date (Oldest)</option>
                                    <option value="returndate-desc">Return Date (Newest)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select id="entriesPerPage" class="form-select">
                                    <option value="10">10 per page</option>
                                    <option value="25">25 per page</option>
                                    <option value="50">50 per page</option>
                                    <option value="100">100 per page</option>
                                </select>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="loansTable">
                                <thead>
                                    <tr>
                                        <th style="width: 8%;">ID</th>
                                        <th style="width: 20%;">Book</th>
                                        <th style="width: 15%;">Borrower</th>
                                        <th style="width: 12%;">Borrow Date</th>
                                        <th style="width: 12%;">Return Date</th>
                                        <th style="width: 10%;">Status</th>
                                        <th style="width: 23%;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {{#each loans}}
                                    <tr data-id="{{this.LoanID}}"
                                        data-book="{{#if this.book}}{{this.book.Title}}{{else}}-{{/if}}"
                                        data-borrower="{{#if this.borrower}}{{this.borrower.FirstName}} {{this.borrower.LastName}}{{else}}-{{/if}}"
                                        data-borrowdate="{{this.BorrowDate}}"
                                        data-returndate="{{#if this.ReturnDate}}{{this.ReturnDate}}{{else}}{{/if}}"
                                        data-status="{{this.Status}}">
                                        <td>{{this.LoanID}}</td>
                                        <td>
                                            {{#if this.book}}
                                                {{this.book.Title}}
                                                {{#if this.book.author}}
                                                    <br><small class="text-muted">by {{this.book.author.FirstName}} {{this.book.author.LastName}}</small>
                                                {{/if}}
                                            {{else}}-{{/if}}
                                        </td>
                                        <td>{{#if this.borrower}}{{this.borrower.FirstName}} {{this.borrower.LastName}}{{else}}-{{/if}}</td>
                                        <td>{{this.BorrowDate}}</td>
                                        <td>{{#if this.ReturnDate}}{{this.ReturnDate}}{{else}}-{{/if}}</td>
                                        <td>
                                            {{#if (eq this.Status 'Borrowed')}}
                                                <span class="badge badge-warning">Borrowed</span>
                                            {{else}}
                                                <span class="badge badge-success">Returned</span>
                                            {{/if}}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-secondary modify-btn" onclick="toggleActions(this)">
                                                <i class="fa fa-pencil"></i> Modify
                                            </button>
                                            <span class="action-buttons" style="display: none;">
                                                <a href="/loans/edit/{{this.LoanID}}" class="btn btn-sm btn-warning">
                                                    <i class="fa fa-edit"></i> Edit
                                                </a>
                                                <form action="/loans/delete/{{this.LoanID}}" method="POST" style="display: inline;" 
                                                      onsubmit="return confirm('Delete this loan?');">
                                                    <input type="hidden" name="_csrf" value="{{../csrfToken}}">
                                                    <button type="submit" class="btn btn-sm btn-danger">
                                                        <i class="fa fa-trash"></i> Delete
                                                    </button>
                                                </form>
                                            </span>
                                        </td>
                                    </tr>
                                    {{/each}}
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div id="tableInfo" class="text-muted"></div>
                            <nav>
                                <ul class="pagination mb-0" id="pagination"></ul>
                            </nav>
                        </div>

                        <script>
                            function toggleActions(btn) {
                                const row = btn.closest('tr');
                                const actionButtons = row.querySelector('.action-buttons');
                                const modifyBtn = row.querySelector('.modify-btn');
                                
                                document.querySelectorAll('.action-buttons').forEach(ab => {
                                    if (ab !== actionButtons) ab.style.display = 'none';
                                });
                                document.querySelectorAll('.modify-btn').forEach(mb => {
                                    if (mb !== modifyBtn) mb.style.display = 'inline-block';
                                });
                                
                                if (actionButtons.style.display === 'none') {
                                    actionButtons.style.display = 'inline';
                                    modifyBtn.style.display = 'none';
                                } else {
                                    actionButtons.style.display = 'none';
                                    modifyBtn.style.display = 'inline-block';
                                }
                            }

                            let currentPage = 1;
                            let entriesPerPage = 10;
                            let filteredRows = [];

                            function initTable() {
                                const table = document.getElementById('loansTable');
                                const rows = Array.from(table.querySelectorAll('tbody tr'));
                                filteredRows = rows;
                                renderTable();
                            }

                            function renderTable() {
                                const table = document.getElementById('loansTable');
                                const tbody = table.querySelector('tbody');
                                const rows = Array.from(tbody.querySelectorAll('tr'));
                                
                                rows.forEach(row => row.style.display = 'none');
                                
                                const totalEntries = filteredRows.length;
                                const totalPages = Math.ceil(totalEntries / entriesPerPage);
                                const start = (currentPage - 1) * entriesPerPage;
                                const end = start + entriesPerPage;
                                
                                filteredRows.slice(start, end).forEach(row => row.style.display = '');
                                
                                const showing = filteredRows.length === 0 ? 0 : start + 1;
                                const to = Math.min(end, totalEntries);
                                document.getElementById('tableInfo').textContent = 
                                    `Showing ${showing} to ${to} of ${totalEntries} entries`;
                                
                                renderPagination(totalPages);
                            }

                            function renderPagination(totalPages) {
                                const pagination = document.getElementById('pagination');
                                pagination.innerHTML = '';
                                
                                if (totalPages <= 1) return;
                                
                                const prevLi = document.createElement('li');
                                prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
                                prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Previous</a>`;
                                pagination.appendChild(prevLi);
                                
                                for (let i = 1; i <= totalPages; i++) {
                                    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                                        const li = document.createElement('li');
                                        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                                        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>`;
                                        pagination.appendChild(li);
                                    } else if (i === currentPage - 3 || i === currentPage + 3) {
                                        const li = document.createElement('li');
                                        li.className = 'page-item disabled';
                                        li.innerHTML = '<a class="page-link" href="#">...</a>';
                                        pagination.appendChild(li);
                                    }
                                }
                                
                                const nextLi = document.createElement('li');
                                nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
                                nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Next</a>`;
                                pagination.appendChild(nextLi);
                            }

                            function changePage(page) {
                                const totalPages = Math.ceil(filteredRows.length / entriesPerPage);
                                if (page < 1 || page > totalPages) return;
                                currentPage = page;
                                renderTable();
                            }

                            function applyFilters() {
                                const searchTerm = document.getElementById('searchLoans').value.toLowerCase();
                                const statusFilter = document.getElementById('filterStatus').value;
                                const table = document.getElementById('loansTable');
                                const rows = Array.from(table.querySelectorAll('tbody tr'));
                                
                                filteredRows = rows.filter(row => {
                                    const matchesSearch = row.dataset.id.toLowerCase().includes(searchTerm) ||
                                                        row.dataset.book.toLowerCase().includes(searchTerm) ||
                                                        row.dataset.borrower.toLowerCase().includes(searchTerm) ||
                                                        row.dataset.borrowdate.toLowerCase().includes(searchTerm) ||
                                                        row.dataset.returndate.toLowerCase().includes(searchTerm);
                                    
                                    const matchesStatus = !statusFilter || row.dataset.status === statusFilter;
                                    
                                    return matchesSearch && matchesStatus;
                                });
                                
                                currentPage = 1;
                                renderTable();
                            }

                            document.getElementById('searchLoans').addEventListener('input', applyFilters);
                            document.getElementById('filterStatus').addEventListener('change', applyFilters);

                            document.getElementById('sortLoans').addEventListener('change', function(e) {
                                const sortValue = e.target.value;
                                
                                if (!sortValue) {
                                    initTable();
                                    return;
                                }
                                
                                const [field, order] = sortValue.split('-');
                                
                                filteredRows.sort((a, b) => {
                                    let aVal, bVal;
                                    
                                    if (field === 'id') {
                                        aVal = parseInt(a.dataset.id);
                                        bVal = parseInt(b.dataset.id);
                                    } else if (field === 'borrowdate') {
                                        aVal = new Date(a.dataset.borrowdate || 0);
                                        bVal = new Date(b.dataset.borrowdate || 0);
                                    } else if (field === 'returndate') {
                                        aVal = new Date(a.dataset.returndate || 0);
                                        bVal = new Date(b.dataset.returndate || 0);
                                    }
                                    
                                    if (order === 'asc') {
                                        return aVal > bVal ? 1 : -1;
                                    } else {
                                        return aVal < bVal ? 1 : -1;
                                    }
                                });
                                
                                renderTable();
                            });

                            document.getElementById('entriesPerPage').addEventListener('change', function(e) {
                                entriesPerPage = parseInt(e.target.value);
                                currentPage = 1;
                                renderTable();
                            });

                            initTable();
                        </script>
                    {{else}}
                        <div class="alert alert-info text-center">
                            No loans found. <a href="/loans/create">Create your first loan</a>
                        </div>
                    {{/if}}
                </div>
            </div>
        </div>
    </div>
</div>
